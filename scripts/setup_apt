#!/bin/sh
#
# Copyright (c) 2012 F-Secure Corporation. All Rights Reserved.
#

SOURCESLIST=/etc/apt/sources.list
SOURCESLIST_BAK=/etc/apt/sources.list.bak
PROXY=/etc/apt/apt.conf.d/00Proxy
PROXY_BAK=/etc/apt/apt.conf.d/00Proxy.bak

TEMP_SOURCESLIST=/sources.list.tmp.$$
TEMP_PROXY=/tmp/00Proxy.tmp.$$

trap "rm -f $TEMP_SOURCESLIST $TEMP_PROXY" EXIT

echo "Please specify APT HTTP proxy or leave blank if none."
echo -n "(e.g. http://host:port): "
read HTTP_PROXY

echo "Generating file $SOURCESLIST..."

cat > $TEMP_SOURCESLIST <<EOF
deb http://ftp.fi.debian.org/debian/ wheezy main contrib non-free
deb-src http://ftp.fi.debian.org/debian/ wheezy main contrib non-free

deb http://security.debian.org/ wheezy/updates main contrib non-free
deb-src http://security.debian.org/ wheezy/updates main contrib non-free
EOF

if [ -n "$HTTP_PROXY" ]; then
    echo "Generating file $PROXY..."

    cat > $TEMP_PROXY <<EOF
Acquire::http::Proxy "$HTTP_PROXY";
EOF
fi

# output generated files

echo
echo "===== $SOURCESLIST ====="
cat $TEMP_SOURCESLIST

if [ -n "$HTTP_PROXY" ]; then
    echo
    echo "===== $PROXY ====="
    cat $TEMP_PROXY
fi

# confirm update

echo -n "Update? [Y/n] "
read CONFIRM

if [ -z "$CONFIRM" -o "$CONFIRM" = "Y" -o "$CONFIRM" = "y" ]; then
    echo
    echo "Updating file $SOURCESLIST..."
    mv $SOURCESLIST $SOURCESLIST_BAK
    mv $TEMP_SOURCESLIST $SOURCESLIST

    if [ -n "$HTTP_PROXY" ]; then
        echo
        echo "Updating file $PROXY..."
        if [ -f $PROXY ]; then
            mv $PROXY $PROXY_BAK
        fi
        mv $TEMP_PROXY $PROXY
    fi

    echo "Done."
else
    echo "Aborted."
fi
