#!/bin/sh
#
# Copyright (c) 2012 F-Secure Corporation. All Rights Reserved.
#

SOURCESLIST=/etc/apt/sources.list
SOURCESLIST_BAK=/etc/apt/sources.list.bak
PROXY=/etc/apt/apt.conf.d/00Proxy
PROXY_BAK=/etc/apt/apt.conf.d/00Proxy.bak

TEMP_SOURCESLIST=/sources.list.tmp.$$
TEMP_PROXY=/tmp/00Proxy.tmp.$$

trap "rm -f $TEMP_SOURCESLIST $TEMP_PROXY" EXIT

echo -n "Please specify APT HTTP proxy (e.g. host:port): "
read HTTP_PROXY

echo "Generating file $SOURCESLIST..."

cat > $TEMP_SOURCESLIST <<EOF
deb http://ftp.fi.debian.org/debian/ wheezy main contrib non-free
deb-src http://ftp.fi.debian.org/debian/ wheezy main contrib non-free

deb http://security.debian.org/ wheezy/updates main contrib non-free
deb-src http://security.debian.org/ wheezy/updates main contrib non-free
EOF

echo "Generating file $PROXY..."

cat > $TEMP_PROXY <<EOF
Acquire::http::Proxy "http://$HTTP_PROXY";
EOF

# output generated files

echo
echo "===== $SOURCESLIST ====="
cat $TEMP_SOURCESLIST

echo
echo "===== $PROXY ====="
cat $TEMP_PROXY

# confirm update

echo -n "Update? [Y/n] "
read CONFIRM

if [ -z "$CONFIRM" -o "$CONFIRM" = "Y" -o "$CONFIRM" = "y" ]; then
    echo
    echo "Updating file $SOURCESLIST..."
    mv $SOURCESLIST $SOURCESLIST_BAK
    mv $TEMP_SOURCESLIST $SOURCESLIST

    echo
    echo "Updating file $PROXY..."
    if [ -f $PROXY ]; then
        mv $PROXY $PROXY_BAK
    fi
    mv $TEMP_PROXY $PROXY

    echo "Done."
else
    echo "Aborted."
fi
